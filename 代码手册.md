# CRP代码手册
###### by dzknb vision 1.4

---

## 简介
- crp是一个解释型语言，由python实现，风格偏向汇编语言，力求代码简洁。
- crp是一个实验性的作品，其运行效率和复杂度不适合开发大型项目。
- 使用方法（推荐）打开`debug.py`使用[调试器](#调试器)编写

---

## 调试器
- 调试器基于tkinter，是crp语言的一个重要编程平台

### 功能
- 调试器接管了运行时`输入`和`输出`功能
- 可以显示运行时所用的[变量](#变量)实际值
- 支持自动运行和单步运行
- 支持发生错误时的中断和提示

### 快捷键

| 功能 | 作用 | 快捷键 |
| --- | --- | --- |
|打开| 打开指定文件|`Crtl + O`|
|保存| 保存到指定文件|`Crtl + S`|
|新建| 新建文件夹| `Ctrl + N`|
|撤销| 撤销最近操作|`Ctrl + Z`|
|复制| 复制选中内容|`Ctrl + C`|
|粘贴| 粘贴复制内容|`Ctrl + V`|
|运行| 运行代码| `F5`|
|停止| 停止运行| `F4`|
|模式| 切换模式|`F12`|
|断点| 设置执行断点|双击代码|

---

## 编写手册 

### 数据类型
- crp支持多种数据类型（均以标志符区分，不做其他校验）

| 类型 | 代号 | 形式 |
| ---- | --- | --- |
|[变量](#变量)  |   `Type:Value`  |  `_value`    |       
|[字符串](#字符串)|  `Type:String` |  `"string"`|
|[数字](#数字)|  `Type:Int` |     `'123456'` |
|[小数（浮点数）](#小数浮点数)|   `Type:Float`| `<1.2345>`| 
|[二进制](#二进制)|`Type:Byte`|`[0;10101]` |
|[标签](#标签)|`Type:Label`|`~label`|
|[列表](列表)|`Type:List`|`{xx;xx;xx}`|
|[包](#包手册)|    | `*math`|
|功能|      | `#out`|
|空|`Type:None`|    |

- 数据类型的转换使用[`typ`](#typ)命令

#### 字符串
- 形如`abc`，`你好`
- 格式: `"xxx"`
- 字符串间相加即为追加
- 索引由最左侧从`0`递增

#### 数字
- 形如`123`，`-1`
- 格式: `'xxx'`
- 可以被[运算](#运算符)

#### 小数（浮点数）
- 形如`1.23`
- 格式: `<x.xx>`
- 可以被[运算](#运算符)

#### 二进制
- 形如`1010`
- 格式：`[x;xxxx]`
- `;`左侧一位为符号位（索引为`-1`），从最右侧索引从`0`递增
- 可以被[移位](#bym)

#### 列表
- 多个值的整体
- 格式`{xx;xx;xx}`
- 索引由`0`开始，元素之间以`;`分割

### 命令列表
- crp命令类似汇编语言，格式相似
- 一般情况下逐行执行命令，换行或[注释](#注释)忽略

|命令格式|说明|
|--------------------------------------|-------------|
|[new](#new) <变量> ... <变量>                 |创建变量|
|[mov](#mov) <变量> <值>                       |复制|
|[add](#add) <变量> <值>                       |加法|
|[sub](#sub) <变量> <值>                       |减法|
|[mul](#mul) <变量> <值>                       |乘法|
|[div](#div) <变量> <值>                       |除法|
|[bym](#bym) <变量> <值>                       |移位|
|[cal](#cal) <返回变量> <功能> <参数> ... <参数> |调用内置功能|
|[got](#got) <标签> <参数>                     |跳转标签|
|[psh](#psh) <变量> <值>                       |列表加入元素|
|[pop](#pop) <变量> <索引>                     |列表删除元素|
|[idx](#pop) <返回值/变量> <索引>               |列表获取元素|
|[cmp](#cmp) <值> <值>                        |比较是否相同（若相同则执行下一行，否则跳过下一行）|
|[ifb](#ifb) <值> <值>                        |比较是否大于（若大于则执行下一行，否则跳过下一行）|
|[ifs](#ifs) <值> <值>                        |比较是否小于（若小于则执行下一行，否则跳过下一行）|
|[typ](#typ) <变量> <类型>                     |强制类型转换|
|[imp](#imp) <包>                             |导入包|
|[put](#put) <错误类型> <错误内容>			|发生错误|
|[err](#err) <标签>                           |指定错误跳转标签|

### 非命令

#### 变量
可以被[改变](#mov)的值

- 变量使用前必须[创建](#new)
- 变量名不允许有`特殊字符`（如空格，[转移符](#转移副)）
- 变量名必须以`_`开头

以下变量是crp运行时自动创建的运行变量

| 变量名 | 作用 | 类型|
| --- | -- | --- |
|`_Error`|发生错误时保存错误类型|`Type:None`|
|`_None`| 占位变量|`Type:None`|

- 所有变量均为`全局变量`

#### 注释
- `;`为注释符号，注释仅能在行开头生效，且为单行注释
- 注释行不会运行，可以不使用转译符

```
;正确的注释
mov _None _None;错误的注释
```

#### 标签
- 当行开头为`~`时，表示定义标签
- 标签记录了当前位置，可使用[`got`](#got)，[`err`](#err)跳转到该位置
- 标签仅记录位置，正常运行时会忽略

#### 转译符
- crp的转译符仅在输入/输出阶段处理，运行中当作正常字符串处理
- crp使用空格作为分隔符，若不想作为分隔，请使用`^s`

| 转译符| 转译后|
| --- | --- |
|`^s`|` `(空格)|
|`^n`|` `(换行)|
|`^d`|`;`|

#### 错误
- 当crp运行发生错误时会将错误类型存入`_Error`
- 可以使用[`err`](#err)和[`put`](#put)手动管理错误

|错误类型| 名称 |  原因  |
| --- | --- | -- |
|`ValueError`|值错误|值不存在或不符合要求|
|`TypeError`|类型错误|值类型错误或不符合要求|
|`ValueExist`|变量存在|变量已经被定义|
|`LoadError`|加载失败|导入包失败|
|`ArguError`|参数错误|参数不符合要求|
|`LabelError`|标签错误|标签不存在或不符合要求|
|`IndexError`|索引错误|索引超出范围或不符合要求|
|`CommandError`|命令错误|存在错误的命令|

- `_Error`的类型为`Type:None`

### 单条命令解释

#### new
用于创建[变量](#变量)
```
new <变量名> ... <变量名>
```
- 可连续创建变量，但是不可重复创建 
- 创建的变量默认类型为`Type:None`
- 该命令为预处理命令，所有变量均为全局

#### mov
用于[变量](#《变量)赋值
```
mov <变量> <值>
```
- 赋值会改变<变量>的类型
- 赋值需要<变量>存在

#### 运算符

##### add
用于变量之间或变量和立即数之间加法
```
add <变量> <值>
```
- 加法后的结果将存入<变量>
- <变量>和<值>的类型需要一致
- 若类型为`Type:String`则为字符串相连
- <变量>和<值>类型不能为`Type:Byte`

##### sub
用于变量之间或变量和立即数之间减法
```
sub <变量> <值>
```
- <变量>和<值>的类型需要一致
- 减法后的结果将存入<变量>
- <变量>和<值>类型不能为`Type:Byte`

##### mul
用于变量之间或变量和立即数之间乘法
```
mul <变量> <值>
```
- <变量>和<值>的类型需要一致
- 乘法后的结果将存入<变量>
- <变量>和<值>类型不能为`Type:Byte`

##### div
用于变量之间或变量和立即数之间除法
```
div <变量> <值>
```
- <变量>和<值>的类型需要一致
- 除法后的结果将存入<变量>
- 除法后的结果为`Type:Float`
- <值>不能为`'0'`
- <变量>和<值>类型不能为`Type:Byte`

#### bym
用于移位操作
```
bym <变量> <偏移量>
```
- <变量>必须存在且类型为`Type:Byte`
- <偏移量>类型为`Type:Int`
- <偏移量>小于`'0'`时，向左移位，大于`‘0’`时向右移位
- 符号位参与移位，多余舍弃，不足补`0`

#### cal
用于调用内置功能
```
cal <返回变量> <命令> (<参数> ... <参数>)
```
- <返回变量>必须存在
- <变量>类型必须为`Type:String`
- 返回值将存入<返回变量>

|返回值|命令|参数|功能|
| --- | --- | ----- | --- |
|     | #out| <输出值>| 输出<输出值>|
|<输入内容>|#in|   |获取输入|
|<类型>|#type|<值>|获取<值>数据类型|
|<处理后值>|#range|<值> <起始索引> <末尾索引>|从<值>中截取部分|
|<长度>|#len|<值>|获取<值>的长度|

#### 分支语句

##### got
用于跳转到指定[标签](#标签)
```
got <标签> (<静默跳转[False]>)
```
- <标签>必须存在
- 当存在`False`参数时，本次跳转将不记录位置
- 当<标签>为`~`时，将跳转回有记录的上次跳转点

##### cmp
用于比较并根据结果决定是否执行下一行
```
cmp <值1> <值2>
<命令1>
<命令2>
```
- <值1>和<值2必须存在
- 比较内容包括二者的类型和值
- 当相同时，会执行<命令1>，否则跳过<命令1>，执行<命令2>
- 当执行<命令1>后由于命令逐行执行，<命令2>也会执行

##### ifs
用于比较小于并根据结果决定是否执行下一行
```
ifs <值1> <值2>
<命令1>
<命令2>
```
- <值1>和<值2>必须存在
- 二者类型必须相同且不能为`Type:Byte`
- 当相同时，会执行<命令1>，否则跳过<命令1>，执行<命令2>
- 当执行<命令1>后由于命令逐行执行，<命令2>也会执行

##### ifb
用于比较大于并根据结果决定是否执行下一行
```
ifb <值1> <值2>
<命令1>
<命令2>
```
- <值1>和<值2>必须存在
- 二者类型必须相同且不能为`Type:Byte`
- 当相同时，会执行<命令1>，否则跳过<命令1>，执行<命令2>
- 当执行<命令1>后由于命令逐行执行，<命令2>也会执行

#### 错误处理

##### put
用于提出一个[错误](#错误)
```
put <错误类型> <错误内容> 
```
- <错误内容>的类型必须为`Type:String`
- 提出错误与运行错误处理逻辑相同

##### err
用于指定错误处理[标签](#标签)
```
err <错误类型> <标签>
```
- <标签>必须存在
- 当发生错误时且指定了错误处理标签，会跳转到<标签>，错误类型保存在`_Error`
- 该命令非预处理命令，后续指定会覆盖先前的指定

##### 列表操作

###### pop
用于从列表中删除指定元素
```
pop <变量> <索引>
```
- <变量>必须存在且类型为`Type:List`
- <索引>类型为`Type:Int`且不能超出范围

###### psh
用于从[列表](#列表)中加入指定元素
```
psh <变量> <值>
```
- <变量>必须存在且类型为`Type:List`
- <值>将加在<变量>末尾

##### idx
用于使用索引获取指定元素
```
idx <变量> <索引>
```
- <变量>必须存在且类型为`Type:List`或者`Type:String`
- <索引>类型为`Type:Int`且不能超出范围
- 获取的元素将存入<变量>

#### typ 
用于类型转换
```
typ <变量> <类型>
```
- <变量>必须存在
- <类型>不能为`Type:Value,Type:Label`
- <变量>必须可以被转换为指定类型
- 目前仅支持`Type:Int`和`Type:Byte`互相转化

#### imp
用于导入包
```
imp <包>
```
- 导入包相当于将包文件内容复制到代码中

- [包手册](#包手册)

### 代码结构（示例）

#### 循环
- crp没有专门的循环命令，使用分支+[`跳转`](#got)代替

```
;初始化
new _count
mov _count '0' 

;循环标签
~loop

;循环内容
cal _None #out "hello^sworld^n"

;循环累加
add _count '1'
;判断循环
ifs _count '10'
got ~loop
```
- 以上代码中将循环`10`次输出`hello world` 

#### 函数
- crp没有专门定义函数和调用函数，使用[`跳转`](#got)+[`赋值`](#mov)代替

```
;调用f(1,2)并输出返回值
mov _f_a '1'
mov _f_b '2'
;跳转到函数标签
got ~f
;继续执行
cal _None #out _f_return
;跳转到末端（结束运行）
got ~end

;定义函数f(f_a,f_b): return(f_a+f_b)
new _f_a _f_b _f_return
~f
;函数内容
add _f_a _f_b
mov _f_return _f_a
;返回跳转点
got ~

;结束位置
~end
```
- 因为crp所有[变量](#变量)和[标签](#标签)均为全局，因此私有变量和私有标签应该加入所属名以便区分

#### 错误处理
- crp的错误处理由[`err`](#err)和[`put`](#put)负责

```
;指定错误处理标签
err ~err
;正常代码 
new _a
mov _a '0'
;模拟发生错误
put “text_error”

;正常代码继续
;跳转到末端（结束运行）
got ~end

;错误处理标签
~err
cal _None #out "发生错误"
;错误处理代码

;结束位置
~end
```
- 以上代码中，发生错误后将会跳转到`~err`继续执行而不是之间退出

---

## 包手册
- 包是crp一个重要部分，包可以被[imp](#imp)导入，通过包可以实现很多功能

- 目前的包有以下几个

|包文件|包名|功能|
| --- | --- | --- |
|math.imp|[*math](#math包)|高级数学运算|
|gui.imp|[*gui](#gui包)|gui操作（tkinter）|
|string.imp|[*string](#string包)|字符串操作|

### 包的调用
- 调用包内功能，需先向指定变量[赋值](#mov)（按需），在[跳转](#got)到功能标签

```
;调用*math中的功能标签 ~math_abs，参数：'-5'，输出返回值
;~math_abs 的参数: _math_abs_argu ，返回变量：_math_abs_return
imp *math
mov _math_abs_argu '-5'
got ~math_abs
cal _None #out _math_abs_return
```

### 自带包

#### math包
用于高级数学运算

|功能标签 | 参数 | 返回值|功能|
| --- | --- | -- | --- |
| `~math_abs`| `_math_abs_argu`|`_math_abs_return`|绝对值|
| `~math_sqrt`|`_math_sqrt_argu`|`_math_sqrt_return`|平方根|


#### gui包
用于图形窗口操作  

|功能标签 | 参数 | 返回值|功能|
| --- | --- | -- | --- |
| `~gui_new`| `_gui_new_size`,`_gui_new_name`|`_gui_new_return`|创建窗口|

#### string包
用于字符串操作

